
rm(list=ls())

# PORTAL DE DATOS ABIERTOS DEL MINISTERIO DE ECONOMÍA Y FINANZAS DEL PERÚ 

library(tidyverse)
library(arrow)

# https://datosabiertos.mef.gob.pe/dataset?q=inversi&page=1&sort=nameasce :

VARIABLES_NUMERICAS <- c( "MONTO_VIABLE"      , "COSTO_ACTUALIZADO" , "CTRL_CONCURR"     , "MONTO_LAUDO"           , "MONTO_FIANZA"     , "PMI_ANIO_1"
                         ,"PMI_ANIO_2"        , "PMI_ANIO_3"        , "PMI_ANIO_4"       , "DEVEN_ACUMUL_ANIO_ANT" , "DEV_ANIO_ACTUAL"  , "PIA_ANIO_ACTUAL"
                         ,"PIM_ANIO_ACTUAL"   , "DEV_ENE_ANIO_VIG"  , "DEV_FEB_ANIO_VIG" , "DEV_MAR_ANIO_VIG"      , "DEV_ABR_ANIO_VIG" , "DEV_MAY_ANIO_VIG"
                         ,"DEV_JUN_ANIO_VIG"  , "DEV_JUL_ANIO_VIG"  , "DEV_AGO_ANIO_VIG" , "DEV_SET_ANIO_VIG"      , "DEV_OCT_ANIO_VIG" , "DEV_NOV_ANIO_VIG"
                         ,"DEV_DIC_ANIO_VIG"  , "CERTIF_ANIO_ACTUAL", "SALDO_EJECUTAR"   , "AVANCE_FISICO"         , "AVANCE_EJECUCION" , "PROG_ACTUAL_ANIO_ACTUAL"
                         ,"MONTO_VALORIZACION", "BENEFICIARIO"      , "MONTO_ET_F8"      , "COMPROM_ANUAL_ANIO_ACTUAL" )

VARIABLES_FECHA <- c( "FECHA_REGISTRO"   , "FECHA_VIABILIDAD"  , "FEC_REG_F9"          , "FECHA_ULT_ACT_F12B" , "ULT_FEC_DECLA_ESTIM"
                     ,"FEC_INI_EJECUCION", "FEC_FIN_EJECUCION" , "FEC_INI_EJEC_FISICA" , "FEC_FIN_EJEC_FISICA" )

VARIABLES_DICOTOMICAS <- c("REGISTRADO_PMI","EXPEDIENTE_TECNICO","INFORME_CIERRE","TIENE_F9","TIENE_F8","TIENE_F12B","TIENE_AVAN_FISICO","SANEAMIENTO")

VARIABLES_ENTERAS <- c("ANIO_PROCESO")


proyectos <- 
  read.csv('https://fs.datosabiertos.mef.gob.pe/datastorefiles/DETALLE_INVERSIONES.csv'
           ,colClasses = 'character'
           ,header     = TRUE
           ,na.strings = c('',' ','-','NULL','null','--','-.-')
           ,fileEncoding = 'utf-8'
           ) %>% 
  mutate_if(is.character,trimws) %>% 
  mutate(
     across( VARIABLES_NUMERICAS   , as.numeric )
    ,across( VARIABLES_FECHA       , ~as.Date(.,format="%Y-%m-%d"))
    ,across( VARIABLES_DICOTOMICAS , function(x){x <- ifelse(x=="SI",1,ifelse(x=="NO",0,NA))})
    ,across( VARIABLES_ENTERAS     , as.integer)
    )

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

arrow::write_parquet( detalle , 'DETALLE_INVERSIONES.parquet' )


# Diccionario de datos ----

diccionario <- read.csv('https://fs.datosabiertos.mef.gob.pe/datastorefiles/Detalle_Inversiones_Diccionario.csv')

arrow::write_parquet( diccionario , 'DICCIONARIO.parquet' )


# MEF tipo de municipalidad - listado de municipalidades segun tipo -------------------------------------------------------
# 'https://www.mef.gob.pe/contenidos/presu_publ/migl/metas/Relacion_municipalidades_Tipo_A.pdf'
Tipo_A  <- c( "010101","010201","010701","020101","020801","021101","021801","030101","030201","040101","040701"
              ,"050101","050401","060101","060401","060601","060801","070101","080101","080601","080801","080901"
              ,"090101","100101","100601","110101","110201","110301","110501","120101","120301","120401","120601"
              ,"120701","120801","120901","130101","130401","130901","131201","140101","140201","140301","150101"
              ,"150201","150501","150601","150801","160101","160201","160501","170101","180101","180301","190101"
              ,"200101","200401","200501","200601","200701","200801","210101","210201","210501","210801","211101"
              ,"220101","220601","220801","220901","230101","240101","240301","250101")
#'https://www.mef.gob.pe/contenidos/presu_publ/migl/metas/Relacion_municipalidades_Tipo_B.pdf'
Tipo_B <-  c( "010301","010401","010501","010601","020201","020301","020401","020501","020601","020701","020901"
             ,"021001","021201","021301","021401","021501","021601","021701","021901","022001","030301","030401"
             ,"030501","030601","030701","040201","040301","040401","040501","040601","040801","050201","050301"
             ,"050501","050601","050701","050801","050901","051001","051101","060201","060301","060501","060701"
             ,"060901","061001","061101","061201","061301","080201","080301","080401","080501","080701","081001"
             ,"081101","081201","081301","090201","090301","090401","090501","090601","090701","100201","100301"
             ,"100401","100501","100701","100801","100901","101001","101101","110401","120201","120501","130201"
             ,"130301","130501","130601","130701","130801","131001","131101","150301","150401","150701","150901"
             ,"151001","160301","160401","160601","160701","160801","170201","170301","180201","190201","190301"
             ,"200201","200301","210301","210401","210601","210701","210901","211001","211201","211301","220201"
             ,"220301","220401","220501","220701","221001","230201","230301","230401","240201","250201","250301"
             ,"250401")
# 'https://www.mef.gob.pe/contenidos/presu_publ/migl/metas/Relacion_municipalidades_Tipo_C.pdf'
  Tipo_C <- c( "150102","150103","150104","150105","150106","150107","150108","150109","150110","150111","150112"
              ,"150113","150114","150115","150116","150117","150118","150119","150120","150121","150122","150123"
              ,"150124","150125","150126","150127","150128","150129","150130","150131","150132","150133","150134"
              ,"150135","150136","150137","150138","150139","150140","150141","150142","150143")
# 'https://www.mef.gob.pe/contenidos/presu_publ/migl/metas/Relacion_municipalidades_Tipo_D.pdf'             
Tipo_D <- c( "020105","021803","021809","030109","030213","030216","040102","040103","040104","040105","040106"
             ,"040107","040109","040110","040111","040112","040116","040117","040122","040123","040126","040128"
             ,"040129","040520","050104","050110","050115","050116","060108","070102","070103","070104","070105"
             ,"070106","070107","080104","080105","080106","080108","090118","100102","100111","100606","100608"
             ,"110102","110103","110106","110108","110110","110112","110206","110207","110210","110305","110506"
             ,"110507","110508","120107","120114","120117","120119","120121","120125","120129","120133","120134"
             ,"120302","120303","120305","120430","120434","120606","120808","130102","130103","130104","130105"
             ,"130106","130107","130109","130111","130205","130208","130702","130704","140105","140106","140108"
             ,"140112","140118","140120","140206","150202","150204","150205","150507","150509","150605","150803"
             ,"150805","150806","150810","160108","160112","160113","170103","180104","180302","180303","190109"
             ,"190113","200104","200105","200109","200110","200114","200115","200602","211105","220804","220909"
             ,"220910","230102","230104","230108","230110","240302","250105","250107")
# 'https://www.mef.gob.pe/contenidos/presu_publ/migl/metas/Relacion_municipalidades_Tipo_E.pdf'
Tipo_E <- c( "010108","010110","010112","010113","010115","010118","010119","010303","010307","010309","010510"
             ,"010516","010603","020502","020506","020507","020508","020509","020511","020512","020513","020514"
             ,"020515","020803","020903","020905","020907","021010","021012","021403","021404","021406","021407"
             ,"021408","021410","021507","021703","021705","021706","021806","021807","021808","030102","030211"
             ,"030220","030302","030304","030305","030306","030307","030403","030411","030602","030709","030711"
             ,"030712","030713","040108","040115","040118","040121","040124","040127","040202","040204","040205"
             ,"040206","040208","040302","040303","040305","040307","040310","040311","040313","040402","040403"
             ,"040407","040409","040410","040414","040502","040503","040505","040509","040510","040512","040513"
             ,"040515","040518","040519","040702","040703","040704","040705","040706","040802","040809","050302"
             ,"050503","050507","050602","050603","050604","050616","050620","050621","050702","050705","050804"
             ,"050805","050810","050902","050905","050906","050907","050910","050911","051002","051003","051005"
             ,"051006","051009","051010","051011","051102","060502","080207","080402","080910","081004","081008"
             ,"081202","081203","081208","081211","081304","081307","090104","090107","090111","090303","090308"
             ,"090605","090710","090713","100508","100604","101004","110105","110109","110111","110113","110202"
             ,"110211","110304","110402","110505","120104","120116","120120","120122","120128","120130","120132"
             ,"120136","120202","120208","120210","120212","120213","120215","120402","120404","120405","120407"
             ,"120408","120409","120410","120412","120413","120414","120415","120418","120420","120421","120425"
             ,"120428","120429","120432","120433","120502","120705","120708","120803","120805","120806","120810"
             ,"120903","120905","120908","130202","130203","130204","130207","130306","130402","130403","130703"
             ,"130705","131202","131203","140102","140103","140104","140107","140109","140110","140111","140113"
             ,"140114","140115","140116","140117","140119","140311","150203","150302","150403","150404","150405"
             ,"150406","150502","150504","150505","150508","150510","150512","150513","150514","150515","150602"
             ,"150603","150604","150607","150608","150609","150612","150703","150704","150707","150708","150709"
             ,"150712","150714","150718","150719","150720","150721","150722","150724","150725","150727","150728"
             ,"150729","150730","150812","150902","150906","151004","151007","151010","151012","151013","151014"
             ,"151017","151018","151021","151023","151025","151026","151027","151028","151029","151033","160510"
             ,"160606","170104","170204","170302","180103","180105","180206","180208","190103","190104","190105"
             ,"190107","190111","190112","190202","190203","190204","190205","190207","190307","200107","200108"
             ,"200402","200405","200406","200502","200503","200504","200505","200506","200507","200603","200605"
             ,"200606","200607","200608","200702","200703","200704","200705","200706","200802","200803","200805"
             ,"200806","210306","210709","211002","211302","220102","220103","220105","220106","220205","220206"
             ,"220406","220703","220704","220705","220706","220707","220803","220806","220808","220809","220903"
             ,"220905","220906","220908","220912","220913","220914","230109","230202","230203","230204","230205"
             ,"230206","230302","230403","230404","230405","230406","230407","230408","240102","240103","240105"
             ,"240106","240203","240303","250305")
# 'https://www.mef.gob.pe/contenidos/presu_publ/migl/metas/Relacion_municipalidades_Tipo_F.pdf'
Tipo_F <- c( "010102","010104","010107","010109","010111","010116","010121","010203","010204","010206","010302"
            ,"010305","010306","010310","010312","010502","010504","010505","010506","010508","010509","010511"
            ,"010512","010517","010522","010523","010606","010607","010608","010703","010704","010706","020103"
            ,"020106","020108","020203","020205","020302","020304","020504","020505","020602","020603","020606"
            ,"020607","020610","020802","020804","020902","020904","020906","021005","021006","021007","021008"
            ,"021009","021013","021015","021016","021103","021104","021105","021202","021205","021402","021409"
            ,"021503","021504","021505","021506","021508","021509","021511","021702","021704","021707","021709"
            ,"021710","021805","021902","021903","021905","021910","022003","022006","030104","030106","030203"
            ,"030204","030206","030212","030214","030215","030219","030303","030402","030404","030405","030410"
            ,"030412","030417","030502","030504","030506","030604","030607","030610","030705","030706","030707"
            ,"030708","030710","030714","040113","040114","040119","040125","040308","040312","040404","040405"
            ,"040406","040408","040412","040413","040504","040506","040507","040508","040511","040514","040517"
            ,"040604","040605","040606","040607","040803","040804","040805","040806","040808","040810","040811"
            ,"050105","050107","050108","050111","050202","050203","050206","050303","050304","050402","050403"
            ,"050405","050407","050408","050409","050412","050508","050509","050605","050606","050608","050609"
            ,"050610","050611","050612","050614","050615","050617","050618","050619","050704","050706","050707"
            ,"050802","050803","050806","050807","050809","050903","050904","050908","051007","051008","051103"
            ,"051105","051106","051108","060305","060411","060414","060507","060508","060802","060808","061003"
            ,"061102","061309","080103","080107","080202","080203","080204","080205","080206","080302","080303")
# 'https://www.mef.gob.pe/contenidos/presu_publ/migl/metas/Relacion_municipalidades_Tipo_G.pdf'
tipo_G <- c( "080305","080307","080308","080309","080403","080404","080405","080407","080506","080602","080603"
            ,"080605","080606","080607","080608","080708","080802","080805","080903","080907","080912","081002"
            ,"081005","081007","081106","081207","081302","081303","090106","090108","090109","090112","090115"
            ,"090204","090205","090206","090207","090208","090304","090307","090309","090403","090408","090412"
            ,"090413","090505","090508","090509","090602","090604","090608","090614","090616","090706","090711"
            ,"090721","090722","090723","100105","100112","100202","100206","100208","100307","100311","100313"
            ,"100316","100317","100323","100503","100506","100507","100605","100702","100704","100705","100802"
            ,"100803","101002","101006","101102","110104","110107","110204","110205","110302","110303","110403"
            ,"110404","110405","110503","110504","120105","120106","120108","120111","120112","120113","120126"
            ,"120127","120211","120214","120304","120403","120416","120422","120424","120426","120427","120431"
            ,"120503","120604","120702","120703","120704","120706","120707","120802","120804","120807","120809"
            ,"120902","120904","120906","120907","130206","130304","130305","130605","130805","130808","130811"
            ,"131002","131003","131004","131006","140204","140205","140303","140304","140305","140307","140309"
            ,"140312","150304","150305","150402","150407","150503","150506","150511","150516","150606","150610"
            ,"150611","150705","150710","150711","150715","150717","150732","150804","150808","150809","150811"
            ,"150903","151003","151006","151008","151011","151015","151016","151020","151022","151024","151030"
            ,"151031","151032","160103","160104","160106","160205","160206","160211","160502","160503","160504"
            ,"160506","160509","160511","160602","160603","160605","160704","160705","160802","170102","170203"
            ,"170303","180102","180106","180202","180203","180207","180209","180210","180211","190102","190106"
            ,"190108","190110","190208","190302","190303","190306","190308","200111","200209","200404","200407"
            ,"200408","200804","210109","210111","210207","210209","210211","210212","210302","210304","210305"
            ,"210308","210310","210402","210602","210603","210706","210707","210708","210710","210802","210804"
            ,"210805","210806","210808","210903","211004","211103","211202","211203","211207","211208","211304"
            ,"211306","211307","220104","220202","220204","220302","220305","220402","220403","220404","220405"
            ,"220502","220503","220504","220505","220507","220508","220509","220510","220511","220603","220604"
            ,"220702","220709","220710","220802","220805","220807","220902","220904","220907","220911","221002"
            ,"221005","230103","230105","230106","230303","230402","240104","240304","250102","250106","250202"
            ,"250302","250303","250304")

# Guardar en formato "parquet" : ------
arrow::write_parquet( tipo_municipalidad , 'TIPO_MUNICIPALIDAD.parquet' )


library(tidyverse)
setwd( dirname(rstudioapi::getActiveDocumentContext()$path) )

# naturaleza de la inversión pública ----
PALABRAS_CLAVES_MEJORAMIENTO <- c("MEJORAMIENTO","MEJORAR","MEJORA","CONSTRUCCION","ADQUISICION","FORTALECIMIENTO","OPTIMIZACION","ADECUACION","REMODELACION","ACONDICIONAMIENTO","EQUIPAMIENTO","REPOTENCIACION","REFORZAMIENTO")
PALABRAS_CLAVES_AMPLIACION   <- c("AMPLIACION","DESARROLLO","DESARROLLAR","EXPANSION","EXTENSION","CRECIMIENTO")
PALABRAS_CLAVES_RECUPERACION <- c("RECUPERACION","RECUPERAR","REPARACION","RESTAURACION","REPOSICION","REHABILITACION","RENOVACION","RENOVAR","RECONSTRUCCION","REEMPLAZO","MANTENIMIENTO","REFUERZO","REINSTALACION","RECICLAJE")
PALABRAS_CLAVES_CREACION     <- c("CREACION","CREAR","INSTALACION","IMPLEMENTACION","PUESTA EN MARCHA","NUEVA INFRAESTRUCTURA","CONSTRUCCION","EDIFICACION","OBRA NUEVA","DESARROLLO")

detalle <- 
  detalle_inversiones %>% 
  
  mutate(
     ANIO_VIABILIDAD  = as.integer(format(FECHA_VIABILIDAD,'%Y'))
     # sobrecostos
    ,MTO_SOBRECOSTO   = COSTO_ACTUALIZADO - MONTO_VIABLE
    ,SOBRECOSTO_NIVEL = case_when( COSTO_ACTUALIZADO  < MONTO_VIABLE ~ "SUBCOSTO"
                                  ,COSTO_ACTUALIZADO == MONTO_VIABLE ~ "SIN VARIACION"
                                  ,COSTO_ACTUALIZADO  > MONTO_VIABLE ~ "SOBRECOSTO" )
    ,SOBRECOSTO       = ifelse( COSTO_ACTUALIZADO>MONTO_VIABLE , 1, 0 )
    # calculo de monto de UIT según año
    ,MTO_UIT          = case_when( ANIO_VIABILIDAD==2022 ~ MONTO_VIABLE/4600
                                   ,ANIO_VIABILIDAD==2023 ~ MONTO_VIABLE/4950
                                   ,ANIO_VIABILIDAD==2024 ~ MONTO_VIABLE/5150
                                   ,ANIO_VIABILIDAD< 2022 ~ NA)
    ) %>%
  # filtrar proyectos según criterios de inclusión de población objetivo
  filter(  MARCO     == "INVIERTE" 
         & SITUACION == "VIABLE"
         & ESTADO    == "ACTIVO" 
         & TIPO_INVERSION == "PROYECTO DE INVERSION"
         & ANIO_VIABILIDAD %in% 2022:2024 
         & MTO_UIT <=15000 
      ) %>% 
  select( where( ~!all(is.na(.))) ) %>% 
  # naturaleza del proyecto de inversion
  mutate(
     NOMBRE_INVERSION         = toupper(chartr('ÁÉÍÓÚ', 'AEIOU', NOMBRE_INVERSION))
    ,NATURALEZA_MEJORAMIENTO  = ifelse( grepl( paste(CLAVES_MEJORAMIENTO,collapse="|") , NOMBRE_INVERSION)==TRUE, 1, 0)
    ,NATURALEZA_AMPLIACION    = ifelse( grepl( paste(CLAVES_AMPLIACION  ,collapse="|") , NOMBRE_INVERSION)==TRUE, 1, 0)
    ,NATURALEZA_RECUPERACION  = ifelse( grepl( paste(CLAVES_RECUPERACION,collapse="|") , NOMBRE_INVERSION)==TRUE, 1, 0)
    ,NATURALEZA_CREACION      = ifelse( grepl( paste(CLAVES_CREACION    ,collapse="|") , NOMBRE_INVERSION)==TRUE, 1, 0)
    ,NATURALEZA_TOTAL         = NATURALEZA_MEJORAMIENTO + NATURALEZA_AMPLIACION + NATURALEZA_RECUPERACION + NATURALEZA_CREACION
  ) %>% 
  # MODALIDAD DEL PROYECTO DE INVERSION
  mutate(
     MODALIDAD_DIRECTA   = ifelse( grepl( "ADMINISTRACIÓN DIRECTA" , DES_MODALIDAD) , 1, 0) 
    ,MODALIDAD_INDIRECTA = ifelse( grepl( "POR CONTRATA|(APP)|NÚCLEO EJECUTOR|OBRAS POR IMPUESTOS", DES_MODALIDAD) , 1, 0) 
    ) %>% 
  # variables de tiempo
  mutate(
     TIEMPO_VIABILIDAD = as.numeric( FECHA_VIABILIDAD  - FECHA_REGISTRO    )
    ,TIEMPO_EJECUCION  = as.numeric( FEC_FIN_EJECUCION - FEC_INI_EJECUCION )
  ) %>% 
  # modificación del proyectos de inversión
  mutate(
    MODIFICACION_F8 = if_else( TIENE_F8==1 & ETAPA_F8=="Aprobación de consistencia o modificaciones antes de la aprobación del ET o ET (A)" 
                               , 1 
                               , 0 
                               , missing=0 )
    ) %>% 
  # tipo de municipalidad
  left_join(  tipo_municipalidad %>% select( UBIGEO , TIPO_MUNICIPALIDAD )  , by=join_by(UBIGEO)  ) %>% 
  # Proporción de proyectos que tienen devengados a la fecha actual
  mutate(
    PROP_DEVENGADA  = (DEV_ANIO_ACTUAL + DEVEN_ACUMUL_ANIO_ANT) / COSTO_ACTUALIZADO 
    ,MONTO_ET_F8     = ifelse( is.na(MONTO_ET_F8) , 0 , MONTO_ET_F8 )  
    ,RATIO_ET_VIABLE = MONTO_ET_F8 / MONTO_VIABLE
    ,RATIO_ET_COSTO  = MONTO_ET_F8 / COSTO_ACTUALIZADO
  )

# determinación de la población objetivo
pob <- 
  detalle %>% 
  select(
    CODIGO_UNICO
    ,FUNCION
    ,SOBRECOSTO
    ,TIEMPO_VIABILIDAD
    ,TIEMPO_EJECUCION
    ,BENEFICIARIO
    ,CTRL_CONCURR
    ,MONTO_LAUDO
    ,MONTO_FIANZA
    ,NATURALEZA_MEJORAMIENTO
    ,NATURALEZA_AMPLIACION
    ,NATURALEZA_RECUPERACION
    ,NATURALEZA_CREACION
    ,NATURALEZA_TOTAL
    ,MODALIDAD_DIRECTA
    ,MODALIDAD_INDIRECTA
    ,MODIFICACION_F8
    ,EXPEDIENTE_TECNICO 
    ,REGISTRADO_PMI
    ,DPTO = DEPARTAMENTO
    ,TIPO_MUNICIPALIDAD
    ,RATIO_ET_VIABLE
    ,RATIO_ET_COSTO
  ) %>% 
  na.omit()


arrow::write_parquet( pob , 'poblacion.parquet' )


